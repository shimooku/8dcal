# 実装方針

数式処理の基本構造について説明する

## 基本ロジック

#1
・オペランドスタックを使って計算処理を制御する
・数式から抽出した数値、演算子は1つずつ順次オペランドスタックにpushする
・括弧の処理については後述

#2
・演算子のうち積算と除算は即時実行する
・演算子のうち加算と減算は後で実行する


#3
・積算／除算の即時実行の方法

例1："4 * 3" の場合

```
(1) 積算子または除算子をスタックにpushしたら、次に数値をpushした直後
    に積算除算処理APIを呼ぶ

 オペランドスタック
   +-----------+
   |index|value|
   |-----|-----|
   |  2  |  3  |<右項をpushした直後に積算除算処理APIを呼ぶ
   |  1  |  *  |<演算子
   |  0  |  4  |<左項
   +-----------+

(2) 積算除算処理APIは、スタックから3アイテムをpopし、
   +-----------+
   |index|value|
   |-----|-----|
   +-----------+

(3) 3アイテムを使って演算して、その結果をスタックにpush
   +-----------+
   |index|value|
   |-----|-----|
   |  0  | 12  |<演算結果をpush
   +-----------+
```

例2："5 + 2 - 1 + 4 * 3 + 3" の場合

```
(1) 加算／減算は即実行しないので、"4*3"の右項"3"をpushするまでは、
    すべてがスタックに残っている。

   +-----------+
   |index|value|
   |-----|-----|
   |  8  |  3  |<右項をpushした直後に積算除算処理APIを呼ぶ
   |  7  |  *  |<積算子
   |  6  |  4  |<左項
   |  5  |  +  |
   |  4  |  1  |
   |  3  |  -  |
   |  2  |  2  |
   |  1  |  +  |
   |  0  |  5  |
   +-----------+
       状態１

(2) 積算の右項をpushしたら、積算除算処理APIを呼び出し、
    3アイテムをpopし、計算結果"12"をpushする

   +-----------+
   |index|value|
   |-----|-----|
   |  6  | 12  |<積算結果
   |  5  |  +  |
   |  4  |  1  |
   |  3  |  -  |
   |  2  |  2  |
   |  1  |  +  |
   |  0  |  5  |
   +-----------+
       状態２

(3) 残りの"+3"をpushして状態３になる。

   +-----------+
   |index|value|
   |-----|-----|
   |  8  |  3  |<
   |  7  |  +  |<
   |  6  | 12  |
   |  5  |  +  |
   |  4  |  1  |
   |  3  |  -  |
   |  2  |  2  |
   |  1  |  +  |
   |  0  |  5  |
   +-----------+
       状態３
```

#4
・加算／減算は式をすべてpushした後に実行する
  (この時点でスタックには加算／減算しか残っていない)

(状態３からの続き)

```

(4) スタック上に数式の要素をすべてpushしたら（状態３）、
    オペランドスタック計算処理APIを呼び出す。

(5) オペランドスタック計算処理APIは、スタック最下の3アイテムの演算を
    スタックの残り1つなるまで繰り返し実行する。

   +-----------+
   |index|value|
   |-----|-----|
   |  8  |  3  |
   |  7  |  +  |
   |  6  | 12  |
   |  5  |  +  |
   |  4  |  1  |
   |  3  |  -  |
   |  2  |  2  |<右項
   |  1  |  +  |<加算子
   |  0  |  5  |<左項
   +-----------+
       状態３

   +-----------+
   |index|value|
   |-----|-----|
   |  6  |  3  |
   |  5  |  +  |
   |  4  | 12  |
   |  3  |  +  |
   |  2  |  1  |
   |  1  |  -  |
   |  0  |  7  |<加算結果
   +-----------+
       状態４a

   +-----------+
   |index|value|
   |-----|-----|
   |  6  |  3  |
   |  5  |  +  |
   |  4  | 12  |
   |  3  |  +  |
   |  2  |  1  |<右項
   |  1  |  -  |<減算子
   |  0  |  7  |<左項
   +-----------+
       状態４b

   +-----------+
   |index|value|
   |-----|-----|
   |  4  |  3  |
   |  3  |  +  |
   |  2  | 12  |
   |  1  |  +  |
   |  0  |  6  |<除算結果
   +-----------+
       状態５a

   +-----------+
   |index|value|
   |-----|-----|
   |  4  |  3  |
   |  3  |  +  |
   |  2  | 12  |<右項
   |  1  |  +  |<加算子
   |  0  |  6  |<左項
   +-----------+
       状態５b

   +-----------+
   |index|value|
   |-----|-----|
   |  2  |  3  |
   |  1  |  +  |
   |  0  | 18  |<加算結果
   +-----------+
       状態６a

   +-----------+
   |index|value|
   |-----|-----|
   |  2  |  3  |<右項
   |  1  |  +  |<加算子
   |  0  | 18  |<左項
   +-----------+
       状態６b

   +-----------+
   |index|value|
   |-----|-----|
   |  0  | 21  |<加算結果
   +-----------+
       状態７

(6) スタックに残った値"21"をオペランドスタック計算処理APIの戻り値として
    返し、オペランドスタック計算処理APIを呼び出した基本ロジックAPIは、
    その値を数式の解として返す。

```

## 括弧の処理

#5
・括弧の中の演算は基本ロジックAPIを再帰呼び出しして処理する

例3："2 + 3 * (4 + 5) + 6" の場合

```
(1) 基本ロジックAPIの中で"2 + 3 *"までをスタックに積む(状態８)

 呼び出し側のスタック
    +-----------+
    |index|value|
    |-----|-----|
    |  3  |  *  |
    |  2  |  3  |
    |  1  |  +  |
    |  0  |  2  |
    +-----------+
        状態８

(2) 「開き括弧」に出会ったら、その「開き括弧」に対応する「閉じ括弧」
    までの間にある文字列"4 + 5"を基本ロジックAPI(再帰呼び出し)に渡す


(3) 呼び出し先の基本ロジックAPIは、渡された"4 + 5"をスタックにpushし、
    (状態９)、#4を実行して状態10を得て、基本ロジックAPIの戻り値として返す


                    呼び出し先のスタック
                       +-----------+
                       |index|value|
                       |-----|-----|
                       |  2  |  5  |<右項
                       |  1  |  +  |<加算子
                       |  0  |  4  |<左項
                       +-----------+
                           状態９

                       +-----------+
                       |index|value|
                       |-----|-----|
                       |  0  |  9  |<加算結果
                       +-----------+
                           状態10

(4) 呼び出し元の基本ロジックAPIは、再帰実行した基本ロジックAPIの戻り値"9"
    をスタック*最上*に乗せ(状態11)、#2の考えによって積算"3*9"を#3の方式で
    すぐに実行するので、状態12に移行する。

  呼び出し側のスタック
    +-----------+
    |index|value|
    |-----|-----|
    |  4  |  9  |<右項
    |  3  |  *  |<積算子
    |  2  |  3  |<左項
    |  1  |  +  |
    |  0  |  2  |
    +-----------+
        状態11

    +-----------+
    |index|value|
    |-----|-----|
    |  2  | 27  |<積算結果
    |  1  |  +  |
    |  0  |  2  |
    +-----------+
        状態12

(5) 残りの数式"+ 6"をpushし(状態13)、#4を実行して最終回答を得る(状態14)

    +-----------+
    |index|value|
    |-----|-----|
    |  4  |  6  |
    |  3  |  +  |
    |  2  | 27  |
    |  1  |  +  |
    |  0  |  2  |
    +-----------+
        状態13

    +-----------+
    |index|value|
    |-----|-----|
    |  0  | 35  |<答え
    +-----------+
        状態14

```


以上
